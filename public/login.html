<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Login - Pick 6</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Make your fantasy sports picks and earn points with Pick 6">
    <meta name="theme-color" content="#040d21">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pick 6">
    
    <!-- Icons -->
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="shortcut icon" sizes="32x32" href="favicon.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="aiP6.png">
    <link rel="apple-touch-icon" sizes="192x192" href="favicon.png">
    <link rel="apple-touch-icon" sizes="512x512" href="aiP6.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="loginStyles.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans&display=swap" rel="stylesheet">
    
    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>
    <div class="container">
        <div class="Logo">
            <img src="aiP6.png" alt="Pick 6 Logo">
        </div>
        <div class="card">
            <div class="card-content">
                <div class="forms">
                    <!-- Login Form -->
                    <div class="form login active">
                        <span class="title">Pick 6: Login</span>
                        <form id="login-form">
                            <div class="input-field">
                                <input type="text" name="username" placeholder="Username" required>
                            </div>
                            <div class="input-field">
                                <input type="password" name="password" placeholder="Password" required>
                            </div>
                            <div class="action">
                                <button type="submit">Login</button>
                            </div>
                        </form>
                        <div class="form-link">
                            <span>Don't have an account? <a href="#" id="show-register">Register here</a></span>
                        </div>
                    </div>
                    <!-- Registration Form -->
                    <div class="form register" id="registration-container" style="display:none;">
                        <span class="title">Register</span>
                        <form id="registration-form">
                            <div class="input-field">
                                <input type="text" name="username" placeholder="Username" required>
                            </div>
                            <div class="input-field">
                                <input type="password" name="password" placeholder="Password" required>
                            </div>
                            <div class="action">
                                <button type="submit">Register</button>
                            </div>
                        </form>
                        <div class="form-link">
                            <span>Already have an account? <a href="#" id="show-login">Login here</a></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="login.js"></script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

    <!-- OneSignal Integration -->
    <script>
// Enhanced OneSignal initialization for iOS PWA
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
    try {
        await OneSignal.init({
            appId: "c0849e89-f474-4aea-8de1-290715275d14",
            safari_web_id: "web.onesignal.auto.2fc72fe0-a0df-475b-ad9a-b2dac840a493",
            
            // Enhanced settings for iOS PWA
            allowLocalhostAsSecureOrigin: true,
            autoRegister: false,
            autoResubscribe: true,
            
            // Disable OneSignal's built-in prompts - we'll handle manually
            notifyButton: {
                enable: false,
            },
            
            // Simplified prompt configuration
            promptOptions: {
                slidedown: {
                    autoPrompt: false,
                    actionMessage: "We'd like to send you notifications about your picks and game updates.",
                    acceptButton: "Allow",
                    cancelButton: "Cancel"
                }
            }
        });
        
        console.log('OneSignal initialized successfully');
        
        // Better platform detection
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isPWA = window.navigator.standalone === true;
        const isInBrowser = !isPWA && isIOS;
        
        console.log('Platform info:', {
            isIOS,
            isPWA,
            isInBrowser,
            userAgent: navigator.userAgent,
            standalone: window.navigator.standalone
        });
        
        // Only setup notifications for supported scenarios
        if (isIOS && isPWA) {
            console.log('iOS PWA detected - setting up notifications');
            await setupIOSPWANotifications();
        } else if (!isIOS) {
            console.log('Non-iOS device - setting up standard notifications');
            await setupStandardNotifications();
        } else {
            console.log('iOS browser - notifications not available in browser, only when installed');
        }
        
    } catch (error) {
        console.error('OneSignal initialization failed:', error);
    }
});

async function setupIOSPWANotifications() {
    // Check current permission status
    const permission = Notification.permission;
    console.log('Current notification permission:', permission);
    
    if (permission === 'granted') {
        // Check if subscribed to OneSignal
        try {
            const isSubscribed = await OneSignal.User.PushSubscription.optedIn;
            console.log('OneSignal subscription status:', isSubscribed);
            
            if (!isSubscribed) {
                console.log('Permission granted but not subscribed - subscribing now');
                await OneSignal.User.PushSubscription.optIn();
            }
        } catch (error) {
            console.error('Error checking subscription:', error);
        }
    } else if (permission === 'default') {
        // Setup our custom prompt
        setupNotificationPrompt();
    } else {
        console.log('Notifications denied');
    }
}

async function setupStandardNotifications() {
    const permission = Notification.permission;
    
    if (permission === 'default') {
        setupNotificationPrompt();
    } else if (permission === 'granted') {
        const isSubscribed = await OneSignal.User.PushSubscription.optedIn;
        if (!isSubscribed) {
            await OneSignal.User.PushSubscription.optIn();
        }
    }
}

function setupNotificationPrompt() {
    window.showNotificationPrompt = showNotificationPrompt;
}

async function showNotificationPrompt(onComplete) {
    // Prevent multiple prompts
    if (document.getElementById('notificationPrompt')) {
        if (onComplete) onComplete();
        return;
    }
    
    // Check if user recently dismissed (respect their choice)
    const dismissed = localStorage.getItem('notificationDismissed');
    if (dismissed) {
        const dismissedTime = parseInt(dismissed);
        const daysSince = (Date.now() - dismissedTime) / (1000 * 60 * 60 * 24);
        if (daysSince < 7) {
            console.log('User recently dismissed notification prompt');
            if (onComplete) onComplete();
            return;
        }
    }
    
    console.log('Showing notification prompt');
    
    const promptHTML = `
        <div id="notificationPrompt" style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-in;
            padding: 20px;
            box-sizing: border-box;
        ">
            <div style="
                background: linear-gradient(135deg, #112240 0%, #233554 100%);
                color: #CCD6F6;
                padding: 30px;
                border-radius: 15px;
                max-width: 350px;
                width: 100%;
                text-align: center;
                border: 2px solid #33d9ff;
                animation: slideUp 0.4s ease-out;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            ">
                <div style="font-size: 50px; margin-bottom: 20px;">ðŸ””</div>
                <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #33d9ff;">Stay in the Game!</div>
                <div style="font-size: 16px; margin-bottom: 25px; line-height: 1.5; color: #8892b0;">
                    Get notified when games start, your picks win, and weekly results are in!
                </div>
                <div style="display: flex; gap: 12px; flex-direction: column;">
                    <button id="enableNotifications" style="
                        background: linear-gradient(45deg, #33d9ff, #1fa2d1);
                        color: #0A192F;
                        border: none;
                        padding: 15px 25px;
                        border-radius: 8px;
                        font-weight: bold;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(51, 217, 255, 0.3);
                    ">âœ“ Enable Notifications</button>
                    <button id="skipNotifications" style="
                        background: transparent;
                        color: #8892b0;
                        border: 2px solid #33d9ff;
                        padding: 12px 25px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.3s ease;
                    ">Maybe Later</button>
                </div>
            </div>
        </div>
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
            #enableNotifications:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(51, 217, 255, 0.4);
            }
            #skipNotifications:hover {
                border-color: #8892b0;
                color: #CCD6F6;
            }
        </style>
    `;

    document.body.insertAdjacentHTML('beforeend', promptHTML);

    const removePrompt = () => {
        const prompt = document.getElementById('notificationPrompt');
        if (prompt) {
            prompt.style.animation = 'fadeOut 0.3s ease-out forwards';
            setTimeout(() => {
                prompt.remove();
                if (onComplete) onComplete();
            }, 300);
        }
    };

    document.getElementById('enableNotifications').onclick = async () => {
        try {
            console.log('User clicked enable notifications');
            
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isPWA = window.navigator.standalone === true;
            
            if (isIOS && isPWA) {
                console.log('Requesting iOS PWA notification permission...');
                
                // For iOS PWA, we need to be very careful with timing
                // Request permission using the native API
                const permission = await new Promise((resolve) => {
                    Notification.requestPermission().then(resolve);
                });
                
                console.log('iOS notification permission result:', permission);
                
                if (permission === 'granted') {
                    console.log('Permission granted, subscribing to OneSignal...');
                    
                    // Small delay to ensure permission is fully processed
                    setTimeout(async () => {
                        try {
                            await OneSignal.User.PushSubscription.optIn();
                            console.log('Successfully subscribed to OneSignal');
                            showSuccessMessage('ðŸŽ‰ Notifications enabled! You\'re all set.');
                        } catch (subError) {
                            console.error('OneSignal subscription error:', subError);
                            showErrorMessage('Notifications enabled, but there was an issue with the setup. Please try logging out and back in.');
                        }
                    }, 500);
                    
                } else if (permission === 'denied') {
                    console.log('Permission denied');
                    showErrorMessage('Notifications were blocked. To enable them, go to Settings > Pick 6 > Notifications and turn them on.');
                } else {
                    console.log('Permission dismissed');
                    showErrorMessage('Notification setup was cancelled. You can try again later.');
                }
                
            } else {
                // Non-iOS or non-PWA - use OneSignal's method
                await OneSignal.Slidedown.promptPush();
                showSuccessMessage('ðŸŽ‰ Notifications enabled!');
            }
            
            removePrompt();
            
        } catch (error) {
            console.error('Error enabling notifications:', error);
            
            // More helpful error message for iOS users
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                showErrorMessage('To enable notifications: Go to Settings > Pick 6 > Notifications and turn them on, then restart the app.');
            } else {
                showErrorMessage('Unable to enable notifications. Please check your browser settings and try again.');
            }
            
            removePrompt();
        }
    };

    document.getElementById('skipNotifications').onclick = () => {
        console.log('User skipped notifications');
        localStorage.setItem('notificationDismissed', Date.now().toString());
        removePrompt();
    };
}

function showSuccessMessage(message) {
    const successHTML = `
        <div id="successMessage" style="
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 10001;
            animation: slideDown 0.4s ease-out;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
            max-width: 90%;
            text-align: center;
        ">
            ${message}
        </div>
        <style>
            @keyframes slideDown {
                from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
                to { transform: translateX(-50%) translateY(0); opacity: 1; }
            }
        </style>
    `;
    
    document.body.insertAdjacentHTML('beforeend', successHTML);
    
    setTimeout(() => {
        const successEl = document.getElementById('successMessage');
        if (successEl) {
            successEl.style.animation = 'slideUp 0.3s ease-out forwards';
            setTimeout(() => successEl.remove(), 300);
        }
    }, 4000);
}

function showErrorMessage(message) {
    const errorHTML = `
        <div id="errorMessage" style="
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: bold;
            z-index: 10001;
            animation: slideDown 0.4s ease-out;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
            max-width: 90%;
            text-align: center;
            font-size: 14px;
            line-height: 1.4;
        ">
            ${message}
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', errorHTML);
    
    setTimeout(() => {
        const errorEl = document.getElementById('errorMessage');
        if (errorEl) {
            errorEl.style.animation = 'slideUp 0.3s ease-out forwards';
            setTimeout(() => errorEl.remove(), 300);
        }
    }, 6000);
}

// Make the function globally available
window.showNotificationPrompt = showNotificationPrompt;

        // Make showNotificationPrompt available globally
        window.showNotificationPrompt = showNotificationPrompt;
    </script>
    
</body>
</html>